<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>新闻</title>
	<link rel="stylesheet" href="../static/css/bootstrap.min.css">
<style>
	body {
		padding-top: 70px;
	}
	#china-map {
		height: 800px;
		width: 100%;
	}
	#word-cloud {
		height: 800px;
		width: 100%;
	}
</style>
</head>
<body>
<nav class="navbar navbar-default navbar-fixed-top">
	<div class="container-fluid">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#nav-body" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="javascript:void(0)">新闻</a>
		</div>
		<div class="collapse navbar-collapse" id="nav-body">
			<ul class="nav navbar-nav">
			</ul>
		</div>
	</div>
</nav>
<div class="container-fluid" id="main-body">
	<div class="row">
		<div class="col-sm-offset-2 col-sm-8">
			<ul class="list-group">
				<li class="list-group-item"><div id="china-map"></div></li>
			</ul>
			<ul class="list-group">
				<li class="list-group-item"><div id="word-cloud"></div></li>
			</ul>
			<div class="row">
				<div class="col-xs-6">
					<div class="panel panel-default">
						<div class="panel-heading">新闻更新量（单位：条）</div>
						<ul class="list-group">
							<li class="list-group-item" v-for="spider in normal_spider_list">
								[[ spider[0] ]]<span class="badge">[[ spider[1] ]]</span>
							</li>
						</ul>
					</div>
				</div>
				<div class="col-xs-6">
					<div class="panel panel-danger">
						<div class="panel-heading">未更新（单位：天数）</div>
						<ul class="list-group">
							<li class="list-group-item" v-for="spider in abnormal_spider_list">
								[[ spider[0] ]]<span class="badge">[[ spider[1] ]]</span>
							</li>
						</ul>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>
<div id="test"></div>
<script src="../static/js/jquery-1.11.1.min.js"></script>
<script src="../static/js/echarts.min.js"></script>
<script src="../static/js/china.js"></script>
<script src="../static/js/bootstrap.min.js"></script>
<script src="../static/js/echarts-wordclound.min.js"></script>
<script src="../static/js/vue.min.js"></script>
<script>
$(function(){
	new Vue({
		el: '#main-body',
		delimiters: ['[[', ']]'],
		data(){
			return {
				normal_spider_list: [],
				abnormal_spider_list: [],
			}
		},
		mounted(){
			this.init_pic('/api/get/map/data', {});
		},
		methods: {
			init_pic: function(api, params){
				var
					myChart1 = echarts.init(document.getElementById('china-map')),
					myChart2 = echarts.init(document.getElementById('word-cloud'));
				myChart1.showLoading();
				myChart2.showLoading();
				$.get(api, params, (api_result) => {
					this.init_table_list(api_result);
					this.init_china_map(myChart1, api_result);
					this.init_word_cloud(myChart2, api_result);
				})
			},
			init_table_list: function(api_result){
				this.normal_spider_list = api_result.normal_spider_list;
				this.abnormal_spider_list = api_result.abnormal_spider_list;
			},
			init_china_map: function(myChart, api_result){
				var now = new Date(),
					option = {
					title: {
						text: '政府新闻热度图'
					},
					tooltip: {
					},
					visualMap: {
						show: true,
						x: 'right',
						y: 'top',
						splitList: api_result.bar,
						color: ['#B71C1C', '#FFB74D', '#90CAF9', '#A5D6A7']
					},
					series: [
						{
							name: api_result.current_day,
							type: 'map',
							mapType: 'china',
							selectedMode: 'multiple',
							label: {
								normal: {
									show: true,
								},
								emphasis: {
									show: true,
								}
							},
							itemStyle: {
								normal: {
									borderWidth: .5,
								},
								emphasis: {
									borderWidth: .5,
									borderColor: '#4b0082',
									areaColor: "#ffdead",
								}
							},
							data: api_result.map_data,
						}
					]
				};
				myChart.hideLoading();
				myChart.setOption(option);
			},
			init_word_cloud: function(myChart, api_result){
					var
						data = api_result.cloud_data,
						maskImage = new Image(),
						option = {
							title: {
								text: '热度话题'
							},
							series: [{
								type: 'wordCloud',
								sizeRange: [10, 100],
								rotationRange: [-90, 90],
								rotationStep: 45,
								gridSize: 2,
								shape: 'pentagon',
								maskImage: maskImage,
								textStyle: {
									normal: {
										color: function () {
											return 'rgb(' + [
												Math.round(Math.random() * 160),
												Math.round(Math.random() * 160),
												Math.round(Math.random() * 160)
											].join(',') + ')';
										}
									}
								},
								data: data.sort(function (a, b) {
									return b.value  - a.value;
								})
							}],
						};
					maskImage.onload = function () {
						myChart.hideLoading();
						option.series[0].maskImage
						myChart.setOption(option);
					}
					maskImage.src = '../static/img/logo.png';
			},
		},
	})
})
</script>
</body>
</html>